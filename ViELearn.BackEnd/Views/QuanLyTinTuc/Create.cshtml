@using System.Data
@model List<ViELearn.Models.ProjectModels.DanhMucChung>


@{
    ViewBag.Title = "Thêm bài viết";
    Layout = "~/Views/Shared/_Layoutv3.cshtml";
}
@section stylePageLever{
    <link href="/UITheme/assets/global/plugins/select2/css/select2.min.css" rel="stylesheet" type="text/css" />
    <link href="/UITheme/assets/global/plugins/select2/css/select2-bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/UITheme/assets/global/plugins/bootstrap-multiselect/css/bootstrap-multiselect.css" rel="stylesheet" type="text/css" />
    <link href="/UITheme/assets/global/plugins/bootstrap-summernote/summernote.css" rel="stylesheet" type="text/css" />

    <link href="/UITheme/assets/global/plugins/bootstrap-tagsinput/bootstrap-tagsinput.css" rel="stylesheet" type="text/css" />
    <link href="/UITheme/assets/global/plugins/bootstrap-tagsinput/bootstrap-tagsinput-typeahead.css" rel="stylesheet" type="text/css" />

    <link href="/UITheme/assets/global/plugins/dropzone/dropzone.min.css" rel="stylesheet" type="text/css" />
    <link href="/UITheme/assets/global/plugins/dropzone/basic.min.css" rel="stylesheet" type="text/css" />
    <link href="/UITheme/assets/global/plugins/bootstrap-toastr/toastr.min.css" rel="stylesheet" />
    <link href="~/UITheme/assets/global/plugins/jcrop/css/jquery.Jcrop.min.css" rel="stylesheet" />
    <link href="~/UITheme/assets/pages/css/image-crop.min.css" rel="stylesheet" />
    <link href="/UITheme/assets/global/plugins/ckeditor/css/custom.css" rel="stylesheet" />

    <style type="text/css">
        .table-scrollable > .table > thead > tr > th {
            white-space: pre-wrap !important;
        }

        thead > tr > th {
            vertical-align: middle !important;
        }

        thead > tr:not(:first-child) > th {
            font-weight: normal !important;
            font-size: 85% !important;
        }

        .note-editable p {
            margin: 0;
        }

        .dropzone .note {
            border-left: 0 !important
        }

        .dz-preview {
            display: inline-block;
            padding: 6px;
        }

            .dz-preview:hover {
                background-color: #dedcdc;
            }

        .dz-preview-crop {
            background-color: #dedcdc;
        }

        .btn_remove {
            color: #7b7a71;
            background-color: #e4e4e4;
            border-radius: 50%;
            position: absolute;
            cursor: pointer;
            right: -5px;
            z-index: 2;
            top: auto;
        }
        /*.dz-image-preview:hover btn_remove {
            position: absolute;
            cursor: pointer;
            right: 8px;
            z-index: 2;
            opacity: 1;
        }*/
        #cke_editor1 {
            display: none;
        }

        .row_img:after, .row_img:before {
            display: inline;
        }

        .bootstrap-tagsinput .tag {
            display: grid !important;
        }

        @@media (max-width:767px) {

            .btn-group .btn + .btn, .btn-group .btn + .btn-group, .btn-group .btn-group + .btn, .btn-group .btn-group + .btn-group {
                margin-left: 0;
            }

            .note-editable img {
                width: 100% !important;
            }
        }

        .popover {
            z-index: 99999 !important;
        }

        #box-actions {
            margin-left: 20px;
            float: right;
        }

        #text-warring-content {
            padding: 11px 10px 0px 9px;
            float: right;
            display: inline-block;
            font-size: 18px;
            line-height: 18px;
        }

        .cke_editable .btn-hotline {
            padding: 10px;
            background-color: #BD8E2D;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            text-align: center;
            margin-top: 6px;
            margin-right: 10px;
        }

        .cke_editable .btn-tuvan {
            padding: 10px;
            background-color: #D80D00;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            text-align: center;
            margin-top: 6px;
            margin-right: 10px;
        }

        .btn-hotline a, .btn-tuvan a {
            color: white;
            font-size: 17px;
        }

        .cke_button__simplebutton_icon {
            background-image: url('/UITheme/assets/global/plugins/ckeditor/plugins/add-circle-blue-512.png') !important;
        }

        .cke_button__superbutton_icon {
            background-size: 25px !important;
        }
    </style>
}
@section scriptMainPageLevel{
    <script src="/UITheme/assets/global/scripts/datatable.js" type="text/javascript"></script>
    <script src="/UITheme/assets/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
    <script src="/UITheme/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
    <script src="/UITheme/assets/global/plugins/select2/js/select2.full.min.js" type="text/javascript"></script>
    <script src="/UITheme/assets/global/plugins/bootstrap-multiselect/js/bootstrap-multiselect.js" type="text/javascript"></script>
    <script src="/UITheme/assets/global/plugins/bootstrap-summernote/summernote.min.js" type="text/javascript"></script>
    @*<script src="/UITheme/assets/global/plugins/ckeditor/ckeditor.js"></script>
    <script src="/UITheme/assets/global/plugins/ckeditor/config.js"></script>*@

    <script src="/UITheme/assets/global/plugins/bootstrap-tagsinput/bootstrap-tagsinput.min.js" type="text/javascript"></script>
    <script src="/UITheme/assets/global/plugins/typeahead/handlebars.min.js" type="text/javascript"></script>
    <script src="/UITheme/assets/global/plugins/typeahead/typeahead.bundle.min.js" type="text/javascript"></script>
    <script src="/UITheme/assets/global/plugins/dropzone/dropzone.min.js" type="text/javascript"></script>
    <script src="/UITheme/assets/global/plugins/bootstrap-toastr/toastr.min.js"></script>
    <script src="/UITheme/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script src="/Scripts/moment-with-locales.js"></script>
    <script src="/Scripts/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="/Scripts/clockpicker.js"></script>
}
@section scriptConfigPageLevel{
    @*<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.3.0/jquery.cookie.min.js"></script>*@
    <script type="text/javascript">
        //var dachay = false;

        $(document).ready(function () {
            //console.log($.cookie('catesId'));
         //   $("#cates").val(Cookies.get('newId2'));
            $('.summernote').summernote({
                tabsize: 2,
                height: 400
            });
            $('#btnSearch1').click(function () {
                load();
            });
            $('#btnSearch').click(function () {
                load();
            });
                    var catId = '@ViewBag.catid';
            if (catId>0)
                $('#cates').val(catId);

            $("#cboFilter,#cates").select2();
            //$('#newId').val($.cookie('newId'));
            //console.log($.cookie('newId'));
            //if (typeof (Cookies.get('newId2')) != 'undefined' && Cookies.get('newId2') != null && Cookies.get('newId2') != '') { // $.cookie('newId')
            //    bootbox.confirm({
            //        message: "Có bản lưu tạm, có muốn khôi phục lại dữ liệu không?",
            //        buttons: {
            //            cancel: {
            //                label: 'Không',
            //                className: 'btn-info'
            //            },
            //            confirm: {
            //                label: 'Đồng ý khôi phục',
            //                className: 'btn-danger'
            //            }
            //        },
            //        callback: function (result) {
            //            if (result) {
            //                window.location.replace('/QuanLyTinTuc/Edit/' + Cookies.get('newId2') + '?isHistory=true')
            //            }
            //        }
            //    });
            //}
           // sortable();
            //setInterval(SaveNewsHistory, 30000);
            ////sự kiên khi user thay đổi input
            //$('#title,#slug,#txt_thumb_url,#sapo,#noidung,#thutu').keyup(function () {
            //    isChange = true;
            //});


            $('.note-editable').css('font-size', '18px').css('font-family', 'Arial');
            $('.mt-multiselect').each(function () {
                var btn_class = $(this).attr('class');
                var clickable_groups = ($(this).data('clickable-groups')) ? $(this).data('clickable-groups') : false;
                var collapse_groups = ($(this).data('collapse-groups')) ? $(this).data('collapse-groups') : false;
                var drop_right = ($(this).data('drop-right')) ? $(this).data('drop-right') : false;
                var drop_up = ($(this).data('drop-up')) ? $(this).data('drop-up') : false;
                var select_all = ($(this).data('select-all')) ? $(this).data('select-all') : false;
                var width = ($(this).data('width')) ? $(this).data('width') : '';
                var height = ($(this).data('height')) ? $(this).data('height') : '';
                var filter = ($(this).data('filter')) ? $(this).data('filter') : false;

                // advanced functions
                var onchange_function = function (option, checked, select) {
                    alert('Changed option ' + $(option).val() + '.');
                }
                var dropdownshow_function = function (event) {
                    alert('Dropdown shown.');
                }
                var dropdownhide_function = function (event) {
                    alert('Dropdown Hidden.');
                }

                // init advanced functions
                var onchange = ($(this).data('action-onchange') == true) ? onchange_function : '';
                var dropdownshow = ($(this).data('action-dropdownshow') == true) ? dropdownshow_function : '';
                var dropdownhide = ($(this).data('action-dropdownhide') == true) ? dropdownhide_function : '';

                // template functions
                // init variables
                var li_template;
                if ($(this).attr('multiple')) {
                    li_template = '<li class="mt-checkbox-list"><a href="javascript:void(0);"><label class="mt-checkbox"> <span></span></label></a></li>';
                } else {
                    li_template = '<li><a href="javascript:void(0);"><label></label></a></li>';
                }

                // init multiselect
                $(this).multiselect({
                    nonSelectedText: ' -- Mời chọn -- ',
                    nSelectedText: ' được chọn',
                    showSearch: true,
                    searchText: 'Tìm, lọc',
                    enableClickableOptGroups: clickable_groups,
                    enableCollapsibleOptGroups: collapse_groups,
                    disableIfEmpty: true,
                    enableFiltering: filter,
                    includeSelectAllOption: select_all,
                    dropRight: drop_right,
                    buttonWidth: width,
                    maxHeight: height,
                    onChange: onchange,
                    onDropdownShow: dropdownshow,
                    onDropdownHide: dropdownhide,
                    buttonClass: btn_class,
                    //optionClass: function(element) { return "mt-checkbox"; },
                    //optionLabel: function(element) { console.log(element); return $(element).html() + '<span></span>'; },
        			/*templates: {
		                li: li_template,
		            }*/
                });
            });

            var tags = new Bloodhound({
                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                prefetch: {
                    //url: '/UITheme/typeahead_countries.json',
                    url: '/QuanLyTinTuc/DanhSachTags',
                    filter: function (list) {
                        return $.map(list, function (tagname) {
                            return { name: tagname };
                        });
                    }
                }
            });

            tags.initialize();
            $('#typeahead_tags').tagsinput({
                typeaheadjs: {
                    name: 'tags',
                    displayKey: 'name',
                    valueKey: 'name',
                    source: tags.ttAdapter()
                }
            });

            $('#seo_keywords').tagsinput({});
          ///  editor = CKEDITOR.replace('noidung');

        });
        function ChangeBakground(itm) {
            $('table').find('tr').each(function () {
                $(this).css('background-color', 'white');
            });
            $(itm).parents().parents('tr').css('background-color', 'yellow');
            $(itm).addClass('');
        }
        var dropzonePostUrl = "/QuanLyTinTuc/UploadFile1";
        Dropzone.autoDiscover = false;
        $("#frm_dropzone").dropzone({
            url: dropzonePostUrl,
            acceptedFiles: "image/jpeg,image/png,image/gif",
            resizeWidth: 1280,
            resizeHeight: 1280,
            maxFilesize: 5,
            resizeMethod: 'contain',
            resizeMimeType: 'image/jpeg,image/png,image/gif',
            init: function () {
                this.on("success", function (file, res) {
                    $('#newId').val(res.id)
                    console.log(res);
                    var fileName = file.name;
                    var html = '';
                    html += ' <div class="col-md-3" style="height:80px;padding-top:5px;padding-bottom:5px;margin-top:5px;margin-bottom:5px;">' +
                        '<div  style="cursor:pointer;position:relative;display: inline!important">' +
                        '<i onclick="removeImg(this)" class="fa fa-times btn_remove" aria-hidden="true"></i>' +
                        '<div class="dz-preview dz-processing dz-image-preview dz-success dz-complete">' +
                        '<img onclick="setusethumbnail(this)" style="max-height:80px;max-width:120px;cursor:pointer;" data-dz-thumbnail="" src="/UserData/@ViewBag.userId/' + res.id+'/' + fileName + '" />' +
                        '</div>' +
                        '</div>' + '</div>';
                    if (file.type != "image/jpeg" && file.type != "image/png" && file.type != "image/png" && file.type != "image/gif") {
                        toastr.error("Định dạng ảnh không đúng,xin mời chọn lại đúng file ảnh!");
                    }
                    else {
                        if (file.size < 500000) {
                            $('.modal-body .item-img .row').prepend(html);
                        }
                        else {
                            toastr.error("Dung lượng ảnh đã vượt quá 500Kb,xin mời chọn ảnh lại ảnh!");
                        }
                    }
                    if (this.getUploadingFiles().length === 0 && this.getUploadingFiles().length === 0) {
                        //doSomething();
                        //console.log('all file uploaded');
                    }
                });
                var _this = this;
                this.on("processing", function (file) {
                    _this.options.url = dropzonePostUrl;
                });
            }
        });
        function setusethumbnail(itm) {
            //   alert(1);
            $('.dz-preview').each(function () {
                $(this).removeClass('dz-preview-crop');
            });
            $(itm).parent().addClass('dz-preview-crop');

            var src = $(itm).attr('src');
            $('#thumb_url').val(src);
            //$('#img-crop1').attr('src',src)
            $('#pop-crop-1').data('src', src);
           // console.log(src)
            $('#pop-crop-1').css('display', '');
        }


            function CropImages() {
            //alert(2);
            //console.log($("#crop_x").val());
            //console.log($("#crop_y").val());
            //console.log($("#crop_w").val());
            //console.log($("#crop_h").val());
                $('.dz-preview').each(function () {
                    $(this).removeClass('dz-preview-crop');
                });
            $.ajax({
                data: {
                    x: $("#crop_x").val(),
                    y: $("#crop_y").val(),
                    w: $("#crop_w").val(),
                    h: $("#crop_h").val(),
                    path: $("#crop_Path").val()
                },
                type: 'POST',
                datatype: 'json',
                url: '/QuanLyTinTuc/SaveImageCrop',
                success: function (responsive) {
                    // bootbox.alert("Xóa thành công");
                   var html = '';
                    html += ' <div class="col-md-3" style="height:80px;padding-top:5px;padding-bottom:5px;margin-top:5px;margin-bottom:5px;">' +
                        '<div  style="cursor:pointer;position:relative;display: inline!important">' +
                        '<i onclick="removeImg(this)" class="fa fa-times btn_remove" aria-hidden="true"></i>' +
                        '<div class="dz-preview dz-processing dz-image-preview dz-success dz-complete">' +
                        '<img onclick="setusethumbnail(this)" style="max-height:80px;max-width:120px;cursor:pointer;" data-dz-thumbnail="" src="' + responsive.path + '" />' +
                        '</div>' +
                        '</div>' + '</div>';
                    $('.modal-body .item-img .row').prepend(html);
                }
            });
        }
        function sortable() {
            $("#sortable").sortable();
            //$("#sortable").disableSelection();
        };
         var load = function () {
              //alert(1);
              var title = $('#txTitle').val();
              var cat = $('#cboFilter').val();
              var table = $("#dsBaiViet tbody");

              $.ajax({
                  data: {
                     // id:@ViewBag.Id,
                      title: title,
                      cat: cat
                  },
                  type: 'POST',
                  datatype: 'json',
                  url: '/QuanLyTinTuc/ResultNews',
                  success: function (res) {
                      //response = $.parseJSON(res);
                      //console.log(jQuery.parseJSON(res.data).length);
                      // console.log(res);
                      $('#dsBaiViet tbody').html(res);
                      table.empty();
                      $('#dsBaiViet').DataTable().destroy();
                      table.html(res);
                      $('#dsBaiViet').DataTable({
                          language: {
                              lengthMenu: "Hiển thị _MENU_ bản ghi",
                              search: "Tìm kiếm",
                              info: "Đang ở trang _PAGE_ / _PAGES_ trang",
                              zeroRecords: "Không có bản ghi nào!",
                              infoEmpty: "Không có bản ghi nào!",
                          },
                          retrieve: true,
                          paging: true,
                          searching: false,
                      });
                  },
                  error: function (responsive) {
                      bootbox.alert("Có lỗi xảy ra!");
                  }
              });
          }
        function removeImg(item) {
            var url = $(item).parent().find('img').attr('src');
            //console.log(url);
            $.ajax({
                data: { fName: url },
                url: '/QuanLyAnh/DeleteFile',
                success: function (responsive) {
                    // bootbox.alert("Xóa thành công");
                    $(item).parent().parent().remove();
                }
            });
        }
        function removeNews(itm) {
            bootbox.confirm({
                message: "Bạn có chắc chắn muốn xóa không?",
                buttons: {
                    cancel: {
                        label: 'Không',
                        className: 'btn-info'
                    },
                    confirm: {
                        label: 'Có',
                        className: 'btn-danger'
                    }
                },
                callback: function (result) {
                    if (result) {
                        $(itm).parent().parent().remove();
                       // $('#stt tbody tr:last-child').remove();
                    }
                }
            });
        }
        function set_destname(value) {
            $('#btnSubmitDialog').data('destname', value);
        }
        function clone_val(src, itm) {
            var dest = $(itm).data('destname');
            var id = $('#newId').val();
            var path = $('#' + src).val();
            $.ajax({
                data: { fName: path, id:id },
                url: '/QuanLyTinTuc/CopyFile',
                success: function (responsive) {
                    $('#' + dest).val(responsive.newpath);
                }
            });
        }

        function ShowFilter(name, title) {
            $('.filter').each(function () {
                $(this).hide();
            });
            $('#' + name).show();

            $("#divData").html('');
            //$('#title').text(title);
        }

        function filterChilds(itm, childname) {
            var pid = $(itm).val();
            $("#" + childname + " > option").each(function () {
                if (pid == $(this).data("parent")) {
                    $(this).show();
                    $(this).prop("disabled", false);
                } else {
                    $(this).hide();
                    $(this).prop("disabled", true);
                }
            });
            $("#" + childname + " > option").first().prop("disabled", false);
            $("#" + childname).val(0).trigger('change');
            $("#" + childname).select2("destroy");
            $("#" + childname).select2({});
        }

        function submit(type) {
            var values = '';
            $("#ds-lq tbody tr td a").each(function (index) {
                var id = $(this).data('id');
                values += id + ',';

            });
            //alert($('#cates').val());
            //var pubDate = $('#pub-date').val();
            //var pubtime = $('#pub-time').val();
            //console.log("date:" + pubDate + ",time:" + pubtime);
            //var dateTime = moment(`${pubDate} ${pubtime}`, 'YYYY-MM-DD HH:mm:ss').format();
            $("#type").val(type);
          //  Cookies.remove('newId2');

            if ($('#cates').val() == 0 ||$('#cates').val() == '' || $('#cates').val() == 'undefined') {
                bootbox.alert("Mời bạn chọn chuyên mục!");
                return false;
            }
            if ($('#title').val() == '' || $('#title').val() == 'undefined')
            {
                bootbox.alert("Tiêu đề không được để trống!");
                return false;
            }
            if ($('#slug').val() == '' || $('#slug').val() == 'undefined')
            {
                bootbox.alert("Slug không được để trống!");
                return false;
            }
            if ($('#thutu').val() == '' || $('#thutu').val() == 'undefined') {
                bootbox.alert("Mời nhập số thứ tự!");
                return false;
            }

            $.ajax({
                data: {
                  //  id: $('#newId').val(),
                    _status: (type == 3) ? 2 : 1,
                    _title: $('#title').val(),
                    _slug: $('#slug').val(),
                    _thumbnail: $('#txt_thumb_url').val(),
                    _sapo: $('#sapo').val(),
                    _content: $('#noidung').summernote('code'),
                    _related: values,
                    _cates: $('#cates').val(),
                    //_status: $('#trangthai').val(),
                    _tags: $('#typeahead_tags').val(),
                    _tags_slug: string_to_slugTag($('#typeahead_tags').val()),
                    _thutu: $('#thutu').val(),
                    _meta_keywords: $('#seo_keywords').val(),
                    _meta_description: $('#seo_description').val()
                    //_publishDate: dateTime
                },
                type: 'POST',
                datatype: 'json',
                url: '/QuanLyTinTuc/Save',
                success: function (responsive) {
                    if (responsive.status) {
                        if (type == 0 || type == 3) {
                            //console.log((type == 3) ? "2" : "1");
                            var status = (type == 3) ? "2" : "1";
            window.location.replace("/QuanLyTinTuc/Index?t=1&cat=" + $('#cates').val() + "&" + "status=" + status);
                        } else if (type == 1) {
                            $("#cates").val(responsive.catesId);
                            window.location.replace("/QuanLyTinTuc/Create");
                        } else if (type == 2) {
                            window.location.replace("/QuanLyTinTuc/Edit/" + responsive.newid);
                        }
                    } else {
                        bootbox.alert(responsive.message);
                    }
                },
                error: function (responsive) {
                    bootbox.alert("Lỗi mạng, đường truyền có vấn đề. Xin vui lòng thử lại!");
                }
            });
        }

        var isChange = false;
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "positionClass": "toast-bottom-right",
            "onclick": null,
            "showDuration": "1000",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };
        function isNumberKey(evt) {
            var charCode = (evt.which) ? evt.which : event.keyCode
            if (charCode > 31 && (charCode < 48 || charCode > 57))
                return false;
            return true;
        }
        function update_slug(itm) {
            $('#slug').val(string_to_slug($(itm).val().trim()));
        }
        function string_to_slug(str) {
            str = str.replace(/^\s+|\s+$/g, ''); // trim

            // remove accents, swap ñ for n, etc
            var from = "ÁÄÂÀÃÅČÇĆĎÉĚËÈÊẼĔȆÍÌÎÏŇÑÓÖÒÔÕØŘŔŠŤÚŮÜÙÛÝŸŽáäâàãåčçćďéěëèêẽĕȇíìîïňñóöòôõøðřŕšťúůüùûýÿžþÞĐđßÆa·/_,:;";
            from += "ÁÀẢÃẠáàảãạÂẤẦẨẪẬâấầẩẫậĂẮẰẲẴẶăắằẳẵặĐđÉÈẺẼẸéèẻẽẹÊẾỀỂỄỆêếềểễệÓÒỎÕỌóòỏõọƠỚỜỞỠỢơớờởỡợÔỐỒỔỖỘôốồổỗộÚÙỦŨỤúùủũụƯỨỪỬỮỰưứừửữựÝỲỶỸỴýỳỷỹỵÍÌỈĨỊíìỉĩị";
            var to = "AAAAAACCCDEEEEEEEEIIIINNOOOOOORRSTUUUUUYYZaaaaaacccdeeeeeeeeiiiinnooooooorrstuuuuuyyzbBDdBAa------";
            to += "AAAAAaaaaaAAAAAAaaaaaaAAAAAAaaaaaaDdEEEEEeeeeeEEEEEEeeeeeeOOOOOoooooOOOOOOooooooOOOOOOooooooUUUUUuuuuuUUUUUUuuuuuuYYYYYyyyyyIIIIIiiiii";
            for (var i = 0, l = from.length; i < l; i++) {
                str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
            }
            str = str.toLowerCase();

            str = str.replace(/[^a-z0-9 -]/g, '') // remove invalid chars
                .replace(/\s+/g, '-') // collapse whitespace and replace by
                .replace(/-+/g, '-'); // collapse dashes

            return str;
        }
        function string_to_slugTag(str) {
            str = str.replace(/^\s+|\s+$/g, ''); // trim


            // remove accents, swap ñ for n, etc
            var from = "ÁÄÂÀÃÅČÇĆĎÉĚËÈÊẼĔȆÍÌÎÏŇÑÓÖÒÔÕØŘŔŠŤÚŮÜÙÛÝŸŽáäâàãåčçćďéěëèêẽĕȇíìîïňñóöòôõøðřŕšťúůüùûýÿžþÞĐđßÆa·/_:;";
            from += "ÁÀẢÃẠáàảãạÂẤẦẨẪẬâấầẩẫậĂẮẰẲẴẶăắằẳẵặĐđÉÈẺẼẸéèẻẽẹÊẾỀỂỄỆêếềểễệÓÒỎÕỌóòỏõọƠỚỜỞỠỢơớờởỡợÔỐỒỔỖỘôốồổỗộÚÙỦŨỤúùủũụƯỨỪỬỮỰưứừửữựÝỲỶỸỴýỳỷỹỵÍÌỈĨỊíìỉĩị";
            var to = "AAAAAACCCDEEEEEEEEIIIINNOOOOOORRSTUUUUUYYZaaaaaacccdeeeeeeeeiiiinnooooooorrstuuuuuyyzbBDdBAa-----";
            to += "AAAAAaaaaaAAAAAAaaaaaaAAAAAAaaaaaaDdEEEEEeeeeeEEEEEEeeeeeeOOOOOoooooOOOOOOooooooOOOOOOooooooUUUUUuuuuuUUUUUUuuuuuuYYYYYyyyyyIIIIIiiiii";
            for (var i = 0, l = from.length; i < l; i++) {
                str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
            }

            str = str.toLowerCase()
                .replace(/\s+/g, '-') // collapse whitespace and replace by
                .replace(/-+/g, '-'); // collapse dashes

            //str = str.replace(/[^a-z0-9 -]/g, '') // remove invalid chars
            //alert(str); return;
            return str;
        }
        $('#btn-pop-time').click(function () {
            var now = new Date();
            var month = (now.getMonth() + 1);
            var day = now.getDate();
            if (month < 10)
                month = "0" + month;
            if (day < 10)
                day = "0" + day;
            var today = now.getFullYear() + '-' + month + '-' + day;
            $('#pub-date').val(today);
            $('#pop-time').modal('show');  // #myModal (id of modal box)
        });

        function posts_timer() {
               // var id = $('#newId').val();
              var pubDate = $('#pub-date').val();
              var pubtime = $('#pub-time').val();
              if (pubDate == 0 || pubDate == '' || pubDate == 'undefined') {
                  bootbox.alert("Mời bạn chọn ngày giờ hiển thị!");
                  return false;
              }
                   var pubDate = $('#pub-date').val();
              var pubtime = $('#pub-time').val();
              if (pubDate == 0 || pubDate == '' || pubDate == 'undefined') {
                  bootbox.alert("Mời bạn chọn ngày giờ hiển thị!");
                  return false;
              }
              if ($('#cates').val() == 0 || $('#cates').val() == '' || $('#cates').val() == 'undefined') {
                  bootbox.alert("Mời bạn chọn chuyên mục!");
                  return false;
              }
              if ($('#title').val() == '' || $('#title').val() == 'undefined') {
                  bootbox.alert("Tiêu đề không được để trống!");
                  return false;
              }
              if ($('#slug').val() == '' || $('#slug').val() == 'undefined') {
                  bootbox.alert("Slug không được để trống!");
                  return false;
              }
              if ($('#thutu').val() == '' || $('#thutu').val() == 'undefined') {
                  bootbox.alert("Mời nhập số thứ tự!");
                  return false;
              }
        //      Cookies.remove('newId2');
              // console.log("date:" + pubDate + ",time:" + pubtime);
              var dateTime = moment(`${pubDate} ${pubtime}`, 'YYYY-MM-DD HH:mm:ss').format();
                             $.ajax({
                                 data: {
                                     id: id,
                                    _datetime: dateTime
                                },
                                    url: '/QuanLyTinTuc/UpdateDatetime',
                                    success: function (responsive) {
                                        window.location.replace("/QuanLyTinTuc/Index?t=1&cat=" + $('#cates').val() + "&" + "status=2");

                                }
                            });
          }
        $('.clockpicker').clockpicker({
            placement: 'bottom',
            align: 'left',
            donetext: 'Chọn',
            'default': 'now',
        }).val(DisplayCurrentTime());

        function DisplayCurrentTime() {
            var date = new Date();
            var hours = date.getHours() > 12 ? date.getHours() - 12 : date.getHours();
            hours = hours < 10 ? "0" + hours : hours;
            var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
            time = hours + ":" + minutes;
            //time = hours + ":" + minutes + am_pm;
            return time;
        };
        function OnCrop(itm) {
            var src = $(itm).data('src');
            //console.log(src);
            //return
            $.ajax({
                data: {
                    src: src,
                },
                type: 'POST',
                datatype: 'json',
                url: '/QuanLyTinTuc/Crop',
                success: function (res) {
                    $('#tab_8').html(res);

                },
                error: function (responsive) {
                    bootbox.alert("Có lỗi xảy ra!");
                }
            });
        }

        var WordCountSapo = function (obj, objfrom) {
            var str = $(objfrom).val();
            var words = 0;
            str = str.replace(/(^\s*)|(\s*$)/gi, "");//exclude  start and end white-space
            str = str.replace(/[ ]{2,}/gi, " ");//2 or more space to 1
            str = str.replace(/\n /, "\n"); // exclude newline with a start spacing
            words = str.split(' ').length;
            $(obj).html("Hiện có " + words + "/ 120 từ");
            if (words > 120) {

                toastr.error("Tóm tắt(Sapo) dường như không tối ưu cho SEO, hãy xem lại!");
                return;
            }

        };
        var WordCountContent = function (obj) {
            var str = $($("#noidung").summernote("code")).text()//$('#noidung').summernote('code');
            var words = 0;
            str = str.replace(/(^\s*)|(\s*$)/gi, "");//exclude  start and end white-space
            str = str.replace(/[ ]{2,}/gi, " ");//2 or more space to 1
            str = str.replace(/\n /, "\n"); // exclude newline with a start spacing
            words = str.split(' ').length;
            $(obj).html("Hiện có " + words + "/ 5000 từ");
            if (words > 5000) {

                toastr.error("Nội dung bài viết hơi dài!");
                return;
            }
        };

    </script>
}
@section actionMenu{
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li><i class="fa fa-plus icon-home"></i> <i class="fa fa-angle-right"></i></li>
            <li><a href="/QuanLyTinTuc">Danh sách</a> <i class="fa fa-angle-right"></i></li>
            <li><span>@ViewBag.Title</span></li>
        </ul>
        <div class="page-toolbar">
            <div class="btn-group pull-right">
                <div style="float: left;">
                    <button class="btn-submit btn btn-info " onclick="submit(1);"><i class="fa fa-save"></i> Lưu, nhập mới</button>
                    <button class="btn-submit btn btn-primary " onclick="submit(0);"><i class="fa fa-save"></i> Lưu xong đóng</button>
                </div>
                <div id="box-actions">
                    <button  id="btn-pop-time" class="btn btn-success"><i class="fa fa-clock-o"></i>  Hẹn giờ xuất bản</button>
                    <button id="btn-pop-public " class="btn btn-success " onclick="submit(3);"><i class="fa fa-globe"></i> Xuất bản</button>
                </div>
                @*<button class="btn btn-danger" onclick="submit(2);"><i class="fa fa-save"></i> Công khai</button>*@
            </div>
        </div>
    </div>
}
<style>

    .box-left {
        right: 0 !important;
    }

    .box-right {
        left: 0 !important;
        right: 1% !important;
    }
</style>
<div class="row">
    <div class="col-lg-8 col-md-7 col-sm-6 col-lg-pull-4 col-md-pull-5 col-sm-pull-6 box-left">
        <div class="row">
            @*<div class="form-group col-md-12">
            Chuyên mục:
            <select name="cates" id="cates" class="form-control select2" style="width:100%">
                <option value="0">---Chọn---</option>
                @foreach (DataRow dr in ViewBag.DsCat.Rows)
                {
                    <option value="@dr["id"]" >@dr["TenDanhMuc"]</option>
                }
            </select>
        </div>*@
            <div class="portlet box green">
                <div class="portlet-title">
                    <div class="caption">
                        Chuyên mục
                    </div>
                    <div class="tools">
                        <a href="javascript:;" class="collapse" data-original-title="" title=""> </a>

                    </div>
                </div>
                <div class="portlet-body">
                    <div class="form-group ">

                        <select name="cates" id="cates" class="form-control select2" style="width:100%">
                            <option value="0">---Chọn---</option>
                            @if (Model != null)
                            {
                                var items = Model.Where(x => x.idDanhMucCha == 0);
                                foreach (var item in items)
                                {
                                    var childCategory = Model.Where(x => x.idDanhMucCha == item.id);
                                    <option value="@item.id"> @item.TenDanhMuc</option>
                                    if (childCategory.Count() > 0)
                                    {
                                        foreach (var child in childCategory)
                                        {
                                            <option value="@child.id"> &nbsp;&nbsp;&nbsp; - @child.TenDanhMuc</option>
                                        }
                                    }
                                }
                            }
                        </select>
                    </div>

                </div>

            </div>

            <div class="form-group col-md-12">
                Tên bài viết: <span class="font-red">(*)</span>
                <input name="title" id="title" class="form-control required-nonestyle" onkeyup="update_slug(this);" value="" />
            </div>
            <div class="form-group col-md-12">
                Tóm tắt:<span style="float:right" id="text-warring" class="font-red"></span>
                <textarea name="sapo" id="sapo" onkeyup="WordCountSapo($('#text-warring'),this)" class="form-control" rows="4"></textarea>
            </div>
            <div class="col-md-12 portlet box green">
                <div class="portlet-title">
                    <div class="caption">
                        Nội dung:
                    </div>
                    <div class="tools">
                        <a href="javascript:;" class="collapse" data-original-title="" title=""> </a>

                    </div>
                    <div id="text-warring-content" class="font-red-thunderbird"></div>
                </div>
                <div class="portlet-body">

                    <div class="form-group ">

                        <textarea name="noidung" id="noidung" class="form-control summernote" rows="4"></textarea>
                    </div>

                </div>

            </div>
            @*<div class="form-group col-md-12">

            <textarea name="noidung" id="noidung" class="form-control summernote" rows="4"></textarea>
        </div>*@
        </div>
    </div>
    <div class="col-lg-4 col-md-5 col-sm-6 col-lg-push-8 col-md-push-7 col-sm-push-6 box-right">
        <div class="portlet box green">
            <div class="portlet-title">
                <div class="caption">

                </div>
                <div class="tools">
                    <a href="javascript:;" class="collapse" data-original-title="" title=""> </a>
                    @*<a href="#portlet-config" data-toggle="modal" class="config" data-original-title="" title=""> </a>*@
                </div>
            </div>
            <div class="portlet-body">
                <div class="form-group">
                    Thứ tự hiển thị
                    <input type="number" name="Thứ tự" id="thutu" class="form-control " />
                </div>
                <div class="form-group">
                    <label>Ảnh avatar</label>
                    <div class="input-group">
                        <input id="txt_thumb_url" type="text" class="form-control" placeholder="Đường dẫn đến ảnh">
                        <span class="input-group-btn">
                            <a data-target="#full-width" class="btn btn-success" data-toggle="modal" onclick="set_destname('txt_thumb_url');"> <i class="fa fa-upload fa-fw"></i> </a>
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    Từ khóa, tags:
                    <input type="text" value="" id="typeahead_tags">
                </div>
            </div>

        </div>

        <div class="portlet box green">
            <div class="portlet-title">
                <div class="caption">
                    SEO
                </div>
                <div class="tools">
                    <a href="javascript:;" class="collapse" data-original-title="" title=""> </a>
                    @*<a href="#portlet-config" data-toggle="modal" class="config" data-original-title="" title=""> </a>*@
                </div>
            </div>
            <div class="portlet-body">
                <div class="form-group">
                    Slug: <span class="font-red">(*)</span>
                    <input name="slug" id="slug" class="form-control required-nonestyle" value="" />
                </div>
                <div class="form-group">
                    Meta-keywords:
                    <input type="text" value="" id="seo_keywords">
                </div>
                <div class="form-group">
                    Meta-description:
                    <input type="text" class="form-control" value="" id="seo_description">
                </div>
            </div>

        </div>
        <div class="portlet box green col-sm-12">
            <div class="portlet-title">
                <div class="caption">
                    Bài liên quan:
                </div>
                <div class="tools">
                    <a href="javascript:;" class="collapse" data-original-title="" title=""> </a>
                    <a href="" class="fullscreen" data-original-title="" title=""> </a>
                    <a href="#portlet-config" data-toggle="modal" class="config" data-original-title="" title="" style="display: none;"></a>
                </div>
                <div class="actions">
                    <a id="btnSearch1" class="btn btn-success" data-target="#full-width3" data-toggle="modal"> <i class="fa fa-plus fa-fw"></i> Thêm bài</a>
                </div>
            </div>
            <div class="portlet-body">
                <div class="d-flex flex-nowrap" style="display:inline-flex">
                    @*<table class=" table table-striped table-hover table-bordered" id="stt">
                            <thead>
                                <tr>
                                    <th class="text-center" style="width:15px!important;">STT</th>
                                </tr>
                            </thead>
                            <tbody id="tStt"></tbody>


                        </table>*@

                    <table class=" table table-striped table-hover table-bordered " id="ds-lq">

                        <thead>
                            <tr>
                                <th class="text-center" style="width:15px!important;">STT</th>
                                <th style="width:400px">Tên bài viết</th>
                                <th class="text-center" style="width: 100px!important;">#</th>
                            </tr>
                        </thead>
                        <tbody id="sortable"></tbody>


                    </table>
                </div>
                <input value="" type="hidden" id="newId" />

            </div>
        </div>



        @*<a id="back-to-history" href="">Lấy dữ liệu</a>*@
    </div>

</div>
<!-- full width -->
<div id="full-width" class="modal container fade" tabindex="-1">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title">Chọn ảnh</h4>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label>Đường dẫn ảnh vừa chọn</label>
            <input type="text" id="thumb_url" class="form-control" placeholder="Đường dẫn đến ảnh" value="">
        </div>
        <div class="col-sm-6">
            <div class="dropzone needsclick dz-clickable" id="frm_dropzone">
                <div class="dz-message needsclick">
                    <h3 class="sbold">Thả hình, ảnh vào đây</h3><br>
                    <span class="note needsclick">Các hình, ảnh chụp về bài viết<br />(dung lượng tối đa: 4MB)</span>
                </div>
            </div>

        </div>
        <div class="col-sm-6 item-img ">
            <div class="row">
                @*@if (Directory.Exists(ViewBag.Images))
                    {
                        foreach (var files in Directory.GetFiles(ViewBag.Images))
                        {
                            var info = new FileInfo(files);
                            <div class=" col-md-3" style="height:80px;padding-top:5px;padding-bottom:5px;margin-top:5px;margin-bottom:5px;">
                                <div style="height:80px;width:120px; cursor:pointer;position:relative;display: inline!important">
                                    <i onclick="removeImg(this)" class="fa fa-times btn_remove" aria-hidden="true"></i>

                                    <div class="dz-preview dz-processing dz-image-preview dz-success dz-complete">
                                        <img id="img_id_@Path.GetFileName(info.FullName)" onclick="setusethumbnail(this)" style="max-height:80px;max-width:120px;cursor:pointer;" data-dz-thumbnail="" alt="@Path.GetFileName(info.FullName)" src='/UserData/@ViewBag.userId/Images/@Path.GetFileName(info.FullName)'>
                                    </div>
                                </div>
                            </div>
                        }
                    }*@
            </div>
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="modal-footer">

        <button type="button" data-dismiss="modal" class="btn btn-outline dark">Thôi</button>
        <button id="pop-crop-1" style="display:none" data-target="#full-width4" type="button" data-toggle="modal" onclick="OnCrop(this)" class="btn green">Cắt ảnh</button>
        <button type="button" data-dismiss="modal" class="btn green" id="btnSubmitDialog" data-destname="" onclick="clone_val('thumb_url', this)">Sử dụng hình ảnh</button>
    </div>
</div>
<div id="full-width3" class="modal container fade" tabindex="-1">
    <script>
        function ClonePath(itm) {
            var title = $(itm).data("title");
            var exist = false;
            var id = $(itm).data("id");
            //console.log(id);
            $(".remove-new").each(function () {
                //console.log(id);
                if (id == $(this).data("id")) {
                    exist = true;
                    return false;
                }
            });
            console.log(exist);
            if (exist) {
                bootbox.alert("Đã có bài viết cùng tiêu đề");
            } else {
                var index = $('.tStt').last().text();
                console.log(index);
                if (typeof (index) == 'undefined' || index == null || index == '') {
                    index = '0';
                }
                //var tableStt = '';
                //tableStt += '<tr>'
                //    + ' <td class="text-center">' + (parseInt(index) + 1) + '</td>'
                //    + '</tr>';
                //$('#stt').append(tableStt);

                var html = '';
                html += '<tr>'
                    + ' <td class="tStt text-center">' + (parseInt(index) + 1) + '</td>'
                    + '<td >' + title + '</td>'
                    + '<td class="text-center"><a class="remove-new" data-id = "' + id + '" onclick="removeNews(this)" href="Javascript:void(0)"><i class="fa fa-trash font-red"></i></a></td>'
                    + '</tr>';
                $('#ds-lq').append(html);
            }

        }
    </script>
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title">Chọn bài</h4>
    </div>
    <div class="modal-body">
        <div class="form-group">

            @*<input type="hidden" id="news_url" class="form-control" placeholder="Đường dẫn đến ảnh" value="">*@
            <div class="row">
                <div class="col-md-3">
                    <div>Chọn chuyên mục:</div>
                    <select name="cates" id="cates" class="form-control select2" style="width:100%">
                        <option value="0">---Chọn---</option>
                        @if (Model != null)
                        {
                            var items = Model.Where(x => x.idDanhMucCha == 0);
                            foreach (var item in items)
                            {
                                var childCategory = Model.Where(x => x.idDanhMucCha == item.id);
                                <option value="@item.id"> @item.TenDanhMuc</option>
                                if (childCategory.Count() > 0)
                                {
                                    foreach (var child in childCategory)
                                    {
                                        <option value="@child.id"> &nbsp;&nbsp;&nbsp; - @child.TenDanhMuc</option>
                                    }
                                }
                            }
                        }
                    </select>

                </div>

                <div class="col-md-3">
                    <div class="form-group">
                        Tiêu đề:
                        <input id="txTitle" class="form-control " />
                    </div>
                </div>
                <div class="col-md-2">
                    &nbsp;
                    <div class="form-group">
                        <button id="btnSearch" class="btn btn-fit-height btn-primary"><i class="fa fa-search" aria-hidden="true"></i> Tìm kiếm </button>
                    </div>
                </div>

            </div>
            <div class="table-scrollable cover-table">
                <table class="table table-striped table-hover table-bordered" id="dsBaiViet">
                    <thead>
                        <tr>
                            <th class="text-center" style="width:15px!important;">STT</th>
                            <th style="width:400px">Tên bài viết</th>
                            <th class="text-center" style="width: 100px!important;">#</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

            </div>
        </div>

        <div class="clearfix"></div>
    </div>
    <div class="modal-footer">
        <button type="button" data-dismiss="modal" class="btn btn-outline dark">Thôi</button>
        @*<button type="button" data-dismiss="modal" class="btn green" id="btnSubmitDialog2" data-destname="" onclick="clone_new_url('news_url', this)">Sử dụng bài viết</button>*@
    </div>
</div>
<div id="pop-time" class="modal fade" tabindex="-1">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title">  Thời gian hiển thị:</h4>

    </div>
    <div class="modal-body">
        <div class="col-sm-12">
            Hiển thị lúc:
            <div class="row">
                <div class="col-sm-6">
                    <input @*value="@Convert.ToDateTime(ViewBag.Infos["PublishDate"]).ToString("HH:mm")"*@ id="pub-time" class="col-sm-6 form-control clockpicker js-input-time" type="text" name="pub-time" required>
                </div>
                <div class="col-sm-6">
                    <input @*value="@Convert.ToDateTime(ViewBag.Infos["PublishDate"]).ToString("yyyy-MM-dd")"*@ type="date" class="col-sm-6 form-control hasDatepicker date-picker" name="to" id="pub-date" required />
                </div>
            </div>
        </div>

        <div class="clearfix"></div>
    </div>
    <div class="modal-footer">
        <button type="button" data-dismiss="modal" class="btn green" data-destname="" onclick="posts_timer()">Đăng</button>
    </div>
</div>
<div id="full-width4" class="modal container fade" tabindex="-1">

    <div class="modal-body">
        <div class="col-sm-12">
            <div class="tab-pane" id="tab_8">

            </div>
        </div>

        <div class="clearfix"></div>
    </div>
</div>
